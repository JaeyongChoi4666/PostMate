<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>승희의 PostMate</title>
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<main class="container d-flex">
    <div class="calendar" aria-label="달력">
        <div class="cal-header">
            <div class="title" aria-live="polite" aria-atomic="true">
                <span class="month" id="monthLabel">월</span>
                <span class="year" id="yearLabel">년</span>
            </div>
            <div class="controls">
                <span style="font-size: 30px; color: #22d3ee" id="payment" >300,000</span>
                <span style="font-size: 20px; color: #e5e7eb; padding-top: 5px">원</span>
                <button id="prevBtn" aria-label="이전 달">◀</button>
                <button id="todayBtn" class="primary" aria-label="오늘로 이동">오늘</button>
                <button id="nextBtn" aria-label="다음 달">▶</button>
            </div>
        </div>

        <section class="gridHeader" id="dowRow" aria-hidden="true"></section>
        <section class="grid" id="daysGrid" role="feed" aria-label="날짜 그리드"></section>
    </div>

    <!--스케줄 추가 modal -->
    <div class="modal fade" id="popup_addSchedule" tabindex="-1" aria-labelledby="addScheduleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addScheduleLabel">새로운 스케줄 추가하기</h1>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control mb-3" id="scheduleTitle" placeholder="일정명을 입력하세요" value="" name="scheduleTitle" required>
                        <label for="scheduleTitle">일정명</label>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="schStrDate" value="" name="schStrDate" required>
                                <label for="schStrDate">일정 시작일</label>
                            </div>
                        </div>
                        <div class="col-md">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="schEndDate" value="" name="schEndDate" required>
                                <label for="schEndDate">일정 종료일</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="scheduleCategory" aria-label="scheduleCategory" name="scheduleCategory" required>
                            <option value="0" selected>일정 종류를 선택해주세요</option>
                        </select>
                        <label for="scheduleCategory">일정종류</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control mb-3" id="schedulePayment" placeholder="수익금을 입력하세요" name="schedulePayment" step="1000" required>
                        <label for="schedulePayment">수익금</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control mb-3" id="scheduleMemo" placeholder="일정 상세내용을 입력하세요" name="scheduleMemo" style="height: 100px" rows="4"></textarea>
                        <label for="scheduleMemo">일정 상세</label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn primary" id="addSchedule">신규 저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="contract" aria-label="계약">
        <div class="cal-header">
            <div class="container">
                <div class="row">
                    <div class="title d-flex col mb-3" aria-live="polite" aria-atomic="true">
                        <span class="year">계약상황</span>
                        <button type="button" class="btn primary btn-sm" data-bs-toggle="modal" data-bs-target="#popup_addContract">추가</button>
                        <div class="form-check ms-auto">
                            <input class="form-check-input" type="checkbox" value="" id="chk_searchAll">
                            <label class="form-check-label" for="chk_searchAll">종료계약 포함</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-group input-group-sm col">
                        <input type="text" class="form-control" placeholder="찾을 계약명을 입력해주세요" aria-label="Recipient’s username" aria-describedby="basic-addon2" id="conTitle">
                        <button class="input-group-text" id="basic-addon2" onclick="searchContract()">검색</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contractList"></div>

        <!--계약 추가 modal -->
        <div class="modal fade" id="popup_addContract" tabindex="-1" aria-labelledby="addContractLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="addContractLabel">새로운 계약 추가하기</h1>
                    </div>
                    <div class="modal-body">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control mb-3" id="contractTitle" placeholder="계약명을 입력하세요" value="" name="contractTitle" required>
                            <label for="contractTitle">계약명</label>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="strDate" value="" name="strDate" required>
                                    <label for="strDate">계약 시작일</label>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="endDate" value="" name="endDate" required>
                                    <label for="endDate">계약 종료일</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="contractCategory" aria-label="contractCategory" name="contractCategory" required>
                                <option value="0" selected>계약 종류를 선택해주세요</option>
                                <option value="브랜드 블로그">브랜드 블로그</option>
                                <option value="플레이스 관리">플레이스 관리</option>
                                <option value="기타">기타</option>
                            </select>
                            <label for="contractCategory">계약종류</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control mb-3" id="contractPayment" placeholder="계약금을 입력하세요" value="" name="contractPayment" step="1000" required>
                            <label for="contractPayment">요금</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control mb-3" id="contractChannel" placeholder="계약을 수주한 경로를 입력하세요" value="" name="contractChannel" required>
                            <label for="contractChannel">계약 수주 경로</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn primary" id="addContract">신규 저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // ----- Utility: Korean labels -----
    const MONTHS = [
        '1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'
    ];
    const DOW = ['일','월','화','수','목','금','토']; // 일요일 시작

    const monthLabel = document.getElementById('monthLabel');
    const yearLabel  = document.getElementById('yearLabel');
    const dowRow     = document.getElementById('dowRow');
    const daysGrid   = document.getElementById('daysGrid');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const todayBtn   = document.getElementById('todayBtn');

    // Weekday header
    function renderDOW() {
        dowRow.innerHTML = '';
        for (const d of DOW) {
            const el = document.createElement('div');
            el.className = 'dow';
            el.textContent = d;
            dowRow.appendChild(el);
        }
    }

    // State
    const today = new Date();
    let current = new Date(today.getFullYear(), today.getMonth(), 1);
    let selected = null; // Date object or null
    let scheduleData = []; // 일정 데이터를 저장할 전역 변수 추가

    function sameDate(a, b) {
        return a && b && a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }


    // 날짜 문자열을 로컬 시간대 00:00:00으로 변환하는 유틸리티 함수
    function parseLocalDate(dateStr) {
        if (!dateStr) return null;
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    // 특정 날짜가 일정 범위에 포함되는지 확인하는 함수
    function isDateInSchedule(date, schedule) {
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const startDate = parseLocalDate(schedule.SCH_ST_DATE);
        const endDate = parseLocalDate(schedule.SCH_ED_DATE);

        return targetDate >= startDate && targetDate <= endDate;
    }

    // 해당 날짜의 일정들을 반환하는 함수
    function getSchedulesForDate(date) {
        return scheduleData.filter(schedule => isDateInSchedule(date, schedule));
    }

    function render() {
        const year = current.getFullYear();
        const month = current.getMonth();

        monthLabel.textContent = MONTHS[month];
        yearLabel.textContent = String(year);

        // Find first day offset and days in month
        const firstDay = new Date(year, month, 1);
        const startWeekday = firstDay.getDay(); // 0=Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Previous month's trailing days
        const prevDays = startWeekday; // number of cells from previous month (since Sun start)
        const prevMonthDays = new Date(year, month, 0).getDate();

        // Build 6 weeks (42 cells) grid for consistent height
        const totalCells = 35;
        const cells = [];

        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.type = 'button';
            cell.className = 'day';
            cell.setAttribute('role','gridcell');

            const dateSpan = document.createElement('span');
            dateSpan.className = 'date';

            let d, display, inCurrent = false;
            if (i < prevDays) {
                // previous month
                const dayNum = prevMonthDays - prevDays + 1 + i;
                d = new Date(year, month - 1, dayNum);
                display = dayNum;
                cell.classList.add('muted');
            } else if (i < prevDays + daysInMonth) {
                // current month
                const dayNum = i - prevDays + 1;
                d = new Date(year, month, dayNum);
                display = dayNum;
                inCurrent = true;
            } else {
                // next month
                const dayNum = i - (prevDays + daysInMonth) + 1;
                d = new Date(year, month + 1, dayNum);
                display = dayNum;
                cell.classList.add('muted');
            }

            dateSpan.textContent = display;
            cell.appendChild(dateSpan);

            // 해당 날짜의 일정들 가져오기
            const daySchedules = getSchedulesForDate(d);

            // 일정이 있으면 표시
            if (daySchedules.length > 0 && inCurrent) {
                const scheduleContainer = document.createElement('div');
                scheduleContainer.className = 'schedule-indicators';

                // 최대 3개까지만 표시 (더 많으면 +N 표시)
                const maxDisplay = 3;
                daySchedules.slice(0, maxDisplay).forEach(schedule => {
                    const indicator = document.createElement('div');
                    indicator.className = 'schedule-indicator';
                    indicator.textContent = schedule.SCH_TITLE;
                    indicator.title = `${schedule.SCH_TITLE} (${schedule.SCH_ST_DATE} ~ ${schedule.SCH_ED_DATE})`;

                    // 카테고리별 색상 적용 (선택사항)
                    indicator.style.fontSize = '11px';
                    indicator.style.overflow = 'hidden';
                    indicator.style.textOverflow = 'ellipsis';
                    indicator.style.whiteSpace = 'nowrap';
                    indicator.style.backgroundColor = schedule.STATE_COLOR;
                    indicator.style.color = '#1e293b';
                    indicator.style.padding = '2px 4px';
                    indicator.style.borderRadius = '3px';
                    indicator.style.marginTop = '2px';

                    scheduleContainer.appendChild(indicator);
                });

                // 더 많은 일정이 있으면 표시
                if (daySchedules.length > maxDisplay) {
                    const moreIndicator = document.createElement('div');
                    moreIndicator.className = 'schedule-more';
                    moreIndicator.textContent = `+${daySchedules.length - maxDisplay}개`;
                    moreIndicator.style.fontSize = '9px';
                    moreIndicator.style.color = '#94a3b8';
                    moreIndicator.style.marginTop = '2px';
                    scheduleContainer.appendChild(moreIndicator);
                }

                cell.appendChild(scheduleContainer);
            }

            if (sameDate(d, today)) cell.classList.add('today');

            // ARIA label for screen readers
            cell.setAttribute('aria-label', `${d.getFullYear()}년 ${MONTHS[d.getMonth()]} ${d.getDate()}일`);

            // Click to select
            cell.addEventListener('click', () => {
                selected = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                // If clicking an adjacent month cell, navigate to that month
                if (d.getMonth() !== month) {
                    current = new Date(d.getFullYear(), d.getMonth(), 1);
                }
                render();
            });

            cell.addEventListener('dblclick', () => {
                const selectedDay = new Intl.DateTimeFormat("en-CA", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    timeZone: "Asia/Seoul"
                }).format(d);
                console.log("dblclick:"+selectedDay);

                const modal = new bootstrap.Modal(document.getElementById('popup_addSchedule'));
                modal.show();

                $("#schStrDate").val(selectedDay);
            });

            cells.push(cell);
        }

        daysGrid.innerHTML = '';
        for (const c of cells) daysGrid.appendChild(c);
    }

    // Navigation
    prevBtn.addEventListener('click', () => {
        current = new Date(current.getFullYear(), current.getMonth() - 1, 1);
        searchSchedule(current.getFullYear(), current.getMonth());
    });
    nextBtn.addEventListener('click', () => {
        current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
        searchSchedule(current.getFullYear(), current.getMonth());
    });
    todayBtn.addEventListener('click', () => {
        current = new Date(today.getFullYear(), today.getMonth(), 1);
        selected = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        searchSchedule(current.getFullYear(), current.getMonth());
    });

    //이벤트 걸기
    $(document).ready(function() {
        //계약추가
        $("#addContract").on("click", function() {
            const contractTitle     = $("#contractTitle");
            const strDate           = $("#strDate");
            const endDate           = $("#endDate");
            const contractCategory  = $("#contractCategory");
            const contractPayment   = $("#contractPayment");
            const contractChannel   = $("#contractChannel");

            if(contractTitle.val() === ""){
                alert("계약명을 입력하세요.");
                contractTitle.focus();
            }else if(strDate.val() === ""){
                alert("시작일을 입력하세요.");
                strDate.focus();
            }else if(endDate.val() === ""){
                alert("종료일을 입력하세요.");
                endDate.focus();
            }else if(strDate.val() > endDate.val()){
                alert("종료일은 시작일 이후여야 합니다.");
                endDate.focus();
            }else if(contractCategory.val() === "0"){
                alert("계약종류를 선택하세요.");
                contractCategory.focus();
            }else if(contractPayment.val() === ""){
                alert("요금을 입력하세요.");
                contractPayment.focus();
            }else if(contractChannel.val() === ""){
                alert("계약 수주 경로를 입력하세요.");
                contractChannel.focus();
            }else{
                const formData = {
                    contractTitle   : contractTitle.val(),
                    strDate         : strDate.val(),
                    endDate         : endDate.val(),
                    contractCategory: contractCategory.val(),
                    contractPayment : contractPayment.val(),
                    contractChannel : contractChannel.val()
                };
                $.ajax({
                    type: "POST",
                    url: "/addContract",
                    contentType: "application/json; charset=UTF-8",
                    accept: "application/json",
                    data: JSON.stringify(formData),
                    processData: false,
                    success: function(response) {
                        alert("계약 저장완료")
                        location.reload();
                    },
                    error: function(xhr) {
                        console.log("status:", xhr.status);
                        console.log("response:", xhr.responseText);
                    }
                })
            }
        });

        //계약검색
        $("#chk_searchAll").on("click", function() {
            searchContract();
        });

        //일정추가
        $("#addSchedule").on("click", function() {
            const scheduleTitle     = $("#scheduleTitle");
            const schStrDate        = $("#schStrDate");
            const schEndDate        = $("#schEndDate");
            const scheduleCategory  = $("#scheduleCategory");
            const schedulePayment   = $("#schedulePayment");
            const scheduleMemo      = $("#scheduleMemo");

            if(scheduleTitle.val() === ""){
                alert("일정명을 입력하세요.");
                scheduleTitle.focus();
            }else if(schStrDate.val() === ""){
                alert("시작일을 입력하세요.");
                schStrDate.focus();
            }else if(schEndDate.val() === ""){
                alert("종료일을 입력하세요.");
                schEndDate.focus();
            }else if(schStrDate.val() > schEndDate.val()){
                alert("종료일은 시작일 이후여야 합니다.");
                schEndDate.focus();
            }else if(scheduleCategory.val() === "0"){
                alert("일정종류를 선택하세요.");
                scheduleCategory.focus();
            }else if(schedulePayment.val() === ""){
                alert("수익금을 입력하세요.");
                schedulePayment.focus();
            }else{
                const formData = {
                    scheduleTitle       : scheduleTitle.val(),
                    schStrDate          : schStrDate.val(),
                    schEndDate          : schEndDate.val(),
                    scheduleCategory    : scheduleCategory.val(),
                    schedulePayment     : schedulePayment.val(),
                    scheduleMemo        : scheduleMemo.val()
                };
                $.ajax({
                    type: "POST",
                    url: "/addSchedule",
                    contentType: "application/json; charset=UTF-8",
                    accept: "application/json",
                    data: JSON.stringify(formData),
                    processData: false,
                    success: function(response) {
                        alert("일정 저장완료")
                        location.reload();
                    },
                    error: function(xhr) {
                        console.log("status:", xhr.status);
                        console.log("response:", xhr.responseText);
                    }
                })
            }
        });


    });

    //검색창에 enter키 입력시 바로 검색
    const searchInput = document.getElementById("conTitle");

    searchInput.addEventListener("keydown", (e) => {
        // 한글 등 조합 중 Enter는 무시
        if (e.isComposing) return;
        if (e.key === "Enter") {
            e.preventDefault();
            const v = searchInput.value.trim();
            if (v) searchContract();
        }
    });

    //사용되는 함수
    function searchContract() {
        $("#contractList").html('');
        $.ajax({
            url: "/searchContract",
            type: "GET",
            dataType: "json",
            data: {
                conTitle    : $("#conTitle").val(),
                allYn       : $("#chk_searchAll").is(":checked") ? "Y" : "N"
            },
            success: function(response) {
                $.each(response, function(i, v) {
                    var div_badge = '';
                    if(v.CON_CATEGORY === '브랜드 블로그'){
                        div_badge = '<span class="badge text-bg-danger" style="display:inline-block;">Brand</span>'
                    }else if(v.CON_CATEGORY === '플레이스 관리'){
                        div_badge = '<span class="badge text-bg-success" style="display:inline-block;">Place</span>'
                    }
                    let innerHTML = '';
                    innerHTML += '<div class="card my-3" style="position: relative;">';
                    innerHTML += '  <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="deleteContract('+v.CON_NO+')" style="position: absolute; top: 10px; right: 10px; z-index: 10;"></button>'
                    innerHTML += '  <div class="d-flex flex-row">';
                    innerHTML += '      <div class="card-body" style="padding-right: 40px;">'
                    innerHTML += '          <div class="fs-6" style="display:inline-block; margin-right:10px;">'+v.CON_TITLE+'</div>'+div_badge+'';
                    innerHTML += '          <div class="mt-1 text-body-secondary" style="font-size: smaller">'+v.CON_ST_DATE+' ~ '+v.CON_ED_DATE+'</div>'
                    innerHTML += '      </div>'
                    innerHTML += '      <div class="card-body d-flex justify-content-end align-items-end" style="font-size: smaller">'+addCommas(v.PAYMENT)+' 원</div>'
                    innerHTML += '  </div>'
                    innerHTML += '</div>'

                    $("#contractList").append(innerHTML);
                })

            },
            error: function (xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
            }
        })
    }

    function addCommas(numStr) {
        return Number(numStr).toLocaleString();
    }

    function deleteContract(conId) {
        if(!confirm('정말 이 계약을 삭제하시겠습니까?')) {
            return;
        }

        $.ajax({
            url: "/deleteContract",
            type: "DELETE",
            data: {
                conId: conId
            },
            success: function(response) {
                alert("삭제되었습니다.");
                searchContract(); // 목록 새로고침
            },
            error: function(xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
                alert("삭제 중 오류가 발생했습니다.");
            }
        });
    }

    function loadScheduleCategory() {
        $.ajax({
            url: "/loadScheduleCategory",
            type: "GET",
            success: function(response) {
                $.each(response, function(i, v) {
                    let innerHTML = '';
                    innerHTML += '<option value="'+v.CATE_NO+'">'+v.CATE_NAME+'</option>';
                    $("#scheduleCategory").append(innerHTML);
                });
            },
            error: function(xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
            }
        });
    }

    function searchSchedule(year, month) {
        const pad = (n) => String(n).padStart(2, '0');
        const fmt = (dt) =>
            `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}`;

        // 1) fistDate: '이 달 1일'이 포함된 주의 일요일
        const firstOfMonth = new Date(year, month, 1);
        const dowFirst = firstOfMonth.getDay(); // 0=일 ~ 6=토
        const fistStart = new Date(firstOfMonth);
        fistStart.setDate(firstOfMonth.getDate() - dowFirst); // 그 주의 일요일

        // 2) lastDate: '이 달 31일(없으면 말일)'이 포함된 주의 토요일
        let anchor = new Date(year, month, 31);
        if (anchor.getMonth() !== month) {
            // 31일이 없는 달이면 말일로 대체
            anchor = new Date(year, month + 1, 0);
        }
        const dowAnchor = anchor.getDay(); // 0=일 ~ 6=토
        const lastEnd = new Date(anchor);
        lastEnd.setDate(anchor.getDate() + (6 - dowAnchor)); // 그 주의 토요일

        const firstDayStr = fmt(fistStart);
        const lastDayStr = fmt(lastEnd);

        $.ajax({
            url: "/searchSchedule",
            type: "GET",
            data: {
                schStrDate: firstDayStr,
                schEndDate: lastDayStr
            },
            success: function(response) {
                // 일정 데이터를 전역 변수에 저장
                scheduleData = response;
                // 달력 다시 렌더링
                render();
            },
            error: function(xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
                alert("삭제 중 오류가 발생했습니다.");
            }
        });

    }

    // Init
    renderDOW();
    render();
    searchContract();
    loadScheduleCategory();
    searchSchedule(today.getFullYear(), today.getMonth());

</script>
</body>
</html>
