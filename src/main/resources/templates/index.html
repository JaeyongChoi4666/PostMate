<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>승희의 PostMate</title>
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<main class="container d-flex">
    <div class="calendar" aria-label="달력">
        <div class="cal-header">
            <div class="title" aria-live="polite" aria-atomic="true">
                <span class="month" id="monthLabel">월</span>
                <span class="year" id="yearLabel">년</span>
            </div>
            <div class="controls">
                <span style="font-size: 30px; color: #22d3ee" id="payment" >300,000</span>
                <span style="font-size: 20px; color: #e5e7eb; padding-top: 5px">원</span>
                <button id="prevBtn" aria-label="이전 달">◀</button>
                <button id="todayBtn" class="primary" aria-label="오늘로 이동">오늘</button>
                <button id="nextBtn" aria-label="다음 달">▶</button>
            </div>
        </div>

        <section class="gridHeader" id="dowRow" aria-hidden="true"></section>
        <section class="grid" id="daysGrid" role="feed" aria-label="날짜 그리드"></section>
    </div>

    <div class="contract" aria-label="계약">
        <div class="cal-header">
            <div class="container">
                <div class="row">
                    <div class="title d-flex col mb-3" aria-live="polite" aria-atomic="true">
                        <span class="year">계약상황</span>
                        <button type="button" class="btn primary btn-sm" data-bs-toggle="modal" data-bs-target="#popup_addContract">추가</button>
                        <div class="form-check ms-auto">
                            <input class="form-check-input" type="checkbox" value="" id="chk_searchAll">
                            <label class="form-check-label" for="chk_searchAll">종료계약 포함</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-group input-group-sm col">
                        <input type="text" class="form-control" placeholder="찾을 계약명을 입력해주세요" aria-label="Recipient’s username" aria-describedby="basic-addon2" id="conTitle">
                        <button class="input-group-text" id="basic-addon2" onclick="searchContract()">검색</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contractList">

        </div>

        <!--계약 추가 modal -->
        <div class="modal fade" id="popup_addContract" tabindex="-1" aria-labelledby="addContractLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="addContractLabel">새로운 계약 추가하기</h1>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-control mb-3" id="contractTitle" placeholder="계약명을 입력하세요" value="" name="contractTitle" required>
                        <label for="contractTitle">계약명</label>

                        <div class="row g-2 mb-3">
                            <div class="col-md">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="strDate" value="" name="strDate" required>
                                    <label for="strDate">계약 시작일</label>
                                </div>
                            </div>

                            <div class="col-md">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="endDate" value="" name="endDate" required>
                                    <label for="endDate">계약 종료일</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select" id="contractCategory" aria-label="contractCategory" name="contractCategory" required>
                                <option value="0" selected>계약 종류를 선택해주세요</option>
                                <option value="브랜드 블로그">브랜드 블로그</option>
                                <option value="플레이스 관리">플레이스 관리</option>
                                <option value="기타">기타</option>
                            </select>
                            <label for="contractCategory">계약종류</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="number" class="form-control mb-3" id="contractPayment" placeholder="계약금을 입력하세요" value="" name="contractPayment" required>
                            <label for="contractPayment">요금</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="text" class="form-control mb-3" id="contractChannel" placeholder="계약을 수주한 경로를 입력하세요" value="" name="contractChannel" required>
                            <label for="contractChannel">계약 수주 경로</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn primary" id="addContract">신규 저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // ----- Utility: Korean labels -----
    const MONTHS = [
        '1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'
    ];
    const DOW = ['일','월','화','수','목','금','토']; // 일요일 시작

    const monthLabel = document.getElementById('monthLabel');
    const yearLabel  = document.getElementById('yearLabel');
    const dowRow     = document.getElementById('dowRow');
    const daysGrid   = document.getElementById('daysGrid');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');
    const todayBtn   = document.getElementById('todayBtn');

    // Weekday header
    function renderDOW() {
        dowRow.innerHTML = '';
        for (const d of DOW) {
            const el = document.createElement('div');
            el.className = 'dow';
            el.textContent = d;
            dowRow.appendChild(el);
        }
    }

    // State
    const today = new Date();
    let current = new Date(today.getFullYear(), today.getMonth(), 1);
    let selected = null; // Date object or null

    function sameDate(a, b) {
        return a && b && a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    function render() {
        const year = current.getFullYear();
        const month = current.getMonth();

        monthLabel.textContent = MONTHS[month];
        yearLabel.textContent = String(year);

        // Find first day offset and days in month
        const firstDay = new Date(year, month, 1);
        const startWeekday = firstDay.getDay(); // 0=Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Previous month's trailing days
        const prevDays = startWeekday; // number of cells from previous month (since Sun start)
        const prevMonthDays = new Date(year, month, 0).getDate();

        // Build 6 weeks (42 cells) grid for consistent height
        const totalCells = 35;
        const cells = [];

        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.type = 'button';
            cell.className = 'day';
            cell.setAttribute('role','gridcell');

            const dateSpan = document.createElement('span');
            dateSpan.className = 'date';

            let d, display, inCurrent = false;
            if (i < prevDays) {
                // previous month
                const dayNum = prevMonthDays - prevDays + 1 + i;
                d = new Date(year, month - 1, dayNum);
                display = dayNum;
                cell.classList.add('muted');
            } else if (i < prevDays + daysInMonth) {
                // current month
                const dayNum = i - prevDays + 1;
                d = new Date(year, month, dayNum);
                display = dayNum;
                inCurrent = true;
            } else {
                // next month
                const dayNum = i - (prevDays + daysInMonth) + 1;
                d = new Date(year, month + 1, dayNum);
                display = dayNum;
                cell.classList.add('muted');
            }

            dateSpan.textContent = display;
            cell.appendChild(dateSpan);

            if (sameDate(d, today)) cell.classList.add('today');

            // ARIA label for screen readers
            cell.setAttribute('aria-label', `${d.getFullYear()}년 ${MONTHS[d.getMonth()]} ${d.getDate()}일`);

            // Click to select
            cell.addEventListener('click', () => {
                selected = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                // If clicking an adjacent month cell, navigate to that month
                if (d.getMonth() !== month) {
                    current = new Date(d.getFullYear(), d.getMonth(), 1);
                }
                render();
            });

            cell.addEventListener('dblclick', () => {
                console.log("dblclick:"+d);
            });


            cells.push(cell);
        }

        daysGrid.innerHTML = '';
        for (const c of cells) daysGrid.appendChild(c);
    }

    // Navigation
    prevBtn.addEventListener('click', () => {
        current = new Date(current.getFullYear(), current.getMonth() - 1, 1);
        render();
    });
    nextBtn.addEventListener('click', () => {
        current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
        render();
    });
    todayBtn.addEventListener('click', () => {
        current = new Date(today.getFullYear(), today.getMonth(), 1);
        selected = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        render();
    });

    //이벤트 걸기
    $(document).ready(function() {
        $("#addContract").on("click", function() {
            const contractTitle = $("#contractTitle").val();
            const strDate = $("#strDate").val()
            const endDate = $("#endDate").val()
            const contractCategory = $("#contractCategory").val()
            const contractPayment = $("#contractPayment").val()
            const contractChannel = $("#contractChannel").val()

            if(contractTitle === ""){
                alert("계약명을 입력하세요.");
                $("#contractTitle").focus();
            }else if(strDate === ""){
                alert("시작일을 입력하세요.");
                $("#strDate").focus();
            }else if(endDate === ""){
                alert("종료일을 입력하세요.");
                $("#endDate").focus();
            }else if(strDate > endDate){
                alert("종료일은 시작일 이후여야 합니다.");
                $("#endDate").focus();
            }else if(contractCategory === "0"){
                alert("계약종류를 선택하세요.");
                $("#contractCategory").focus();
            }else if(contractPayment === ""){
                alert("요금을 입력하세요.");
                $("#contractPayment").focus();
            }else if(contractChannel === ""){
                alert("계약 수주 경로를 입력하세요.");
                $("#contractChannel").focus();
            }else{
                const formData = {
                    contractTitle   : contractTitle,
                    strDate         : strDate,
                    endDate         : endDate,
                    contractCategory: contractCategory,
                    contractPayment : contractPayment,
                    contractChannel : contractChannel
                };
                $.ajax({
                    type: "POST",
                    url: "/addContract",
                    contentType: "application/json; charset=UTF-8",
                    accept: "application/json",
                    data: JSON.stringify(formData),
                    processData: false,
                    success: function(response) {
                        alert("저장완료")
                        location.reload();
                    },
                    error: function(xhr) {
                        console.log("status:", xhr.status);
                        console.log("response:", xhr.responseText);
                    }
                })
            }
        });

        $("#chk_searchAll").on("click", function() {
            searchContract();
        });
    });

    //검색창에 enter키 입력시 바로 검색
    const searchInput = document.getElementById("conTitle");

    searchInput.addEventListener("keydown", (e) => {
        // 한글 등 조합 중 Enter는 무시
        if (e.isComposing) return;
        if (e.key === "Enter") {
            e.preventDefault();
            const v = searchInput.value.trim();
            if (v) searchContract();
        }
    });

    //사용되는 함수
    function searchContract() {
        $("#contractList").html('');
        $.ajax({
            url: "/searchContract",
            type: "GET",
            dataType: "json",
            data: {
                conTitle    : $("#conTitle").val(),
                allYn       : $("#chk_searchAll").is(":checked") ? "Y" : "N"
            },
            success: function(response) {
                $.each(response, function(i, v) {
                    var div_badge = '';
                    if(v.CON_CATEGORY === '브랜드 블로그'){
                        div_badge = '<span class="badge text-bg-danger" style="display:inline-block;">Brand</span>'
                    }else if(v.CON_CATEGORY === '플레이스 관리'){
                        div_badge = '<span class="badge text-bg-success" style="display:inline-block;">Place</span>'
                    }
                    let innerHTML = '';
                    innerHTML += '<div class="card my-3" style="position: relative;">';
                    innerHTML += '  <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="deleteContract('+v.CON_NO+')" style="position: absolute; top: 10px; right: 10px; z-index: 10;"></button>'
                    innerHTML += '  <div class="d-flex flex-row">';
                    innerHTML += '      <div class="card-body" style="padding-right: 40px;">'
                    innerHTML += '          <div class="fs-6" style="display:inline-block; margin-right:10px;">'+v.CON_TITLE+'</div>'+div_badge+'';
                    innerHTML += '          <div class="mt-1 text-body-secondary" style="font-size: smaller">'+v.CON_ST_DATE+' ~ '+v.CON_ED_DATE+'</div>'
                    innerHTML += '      </div>'
                    innerHTML += '      <div class="card-body d-flex justify-content-end align-items-end" style="font-size: smaller">'+addCommas(v.PAYMENT)+' 원</div>'
                    innerHTML += '  </div>'
                    innerHTML += '</div>'

                    $("#contractList").append(innerHTML);
                })

            },
            error: function (xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
            }
        })
    }

    function addCommas(numStr) {
        return Number(numStr).toLocaleString();
    }

    function deleteContract(conId) {
        if(!confirm('정말 이 계약을 삭제하시겠습니까?')) {
            return;
        }

        $.ajax({
            url: "/deleteContract",
            type: "DELETE",
            data: {
                conId: conId
            },
            success: function(response) {
                alert("삭제되었습니다.");
                searchContract(); // 목록 새로고침
            },
            error: function(xhr) {
                console.log("status:", xhr.status);
                console.log("response:", xhr.responseText);
                alert("삭제 중 오류가 발생했습니다.");
            }
        });
    }

    // Init
    renderDOW();
    render();
    searchContract();
</script>
</body>
</html>
